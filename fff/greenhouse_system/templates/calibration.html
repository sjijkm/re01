<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>传感器校准</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>温室智能控制系统</h1>
        <div class="user-info">
            <span>用户: {{ username }} ({{ role }})</span>
            <a href="{{ url_for('logout') }}">退出</a>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="{{ url_for('index') }}">首页</a></li>
            <li><a href="{{ url_for('status') }}">系统状态</a></li>
            <li><a href="{{ url_for('device_control') }}">设备控制</a></li>
            <li><a href="{{ url_for('greenhouses') }}">大棚管理</a></li>
            <li><a href="{{ url_for('history') }}">历史数据</a></li>
            <li><a href="{{ url_for('alerts') }}">报警信息</a></li>
            <li><a href="{{ url_for('schedule') }}">定时任务</a></li>
            <li><a href="{{ url_for('calibration') }}" class="active">传感器校准</a></li>
        </ul>
    </nav>

    <main>
        <h2>传感器校准</h2>

        {% if role != 'admin' %}
        <div class="card"><p>仅管理员可访问</p></div>
        {% else %}
        <div class="card">
            <h3>校准参数</h3>
            <p>公式：实际值 = 原始值 × 缩放系数 + 偏移量</p>
            <form id="calibrationForm">
                {% for cal in calibrations %}
                <div class="form-group">
                    <h4>{{ cal.sensor_type.replace('_', ' ') }}</h4>
                    <input type="hidden" name="sensor" value="{{ cal.sensor_type }}">
                    <label>偏移量：</label>
                    <input type="number" step="0.1" name="offset" value="{{ cal.offset }}" class="form-control">
                    <label>缩放系数：</label>
                    <input type="number" step="0.01" name="scale" value="{{ cal.scale }}" class="form-control" min="0.1" max="2.0">
                </div>
                {% endfor %}
                <button type="submit" class="btn btn-success">保存</button>
            </form>
        </div>
        {% endif %}
    </main>

    <script>
        document.getElementById('calibrationForm').addEventListener('submit', e => {
            e.preventDefault();
            const data = {};
            let currentSensor = '';
            new FormData(e.target).forEach((v, k) => {
                if (k === 'sensor') currentSensor = v;
                else data[currentSensor][k] = parseFloat(v);
            });
            fetch('/api/calibration/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(() => alert('保存成功'));
        });
    </script>
</body>
</html>