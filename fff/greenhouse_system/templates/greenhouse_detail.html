<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ house.name }} - 大棚详情</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>温室智能控制系统</h1>
        <div class="user-info">
            <span>当前用户: {{ username }} ({{ role }})</span>
            <a href="{{ url_for('logout') }}">退出登录</a>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="{{ url_for('index') }}">首页</a></li>
            <li><a href="{{ url_for('greenhouses') }}">大棚管理</a></li>
            <li><a href="{{ url_for('greenhouse_detail', house_id=house.id) }}" class="active">{{ house.name }}详情</a></li>
        </ul>
    </nav>

    <main>
        <h2>{{ house.name }} 监控与种植管理</h2>
        <p>位置：{{ house.location }} | 面积：{{ house.area }}㎡ | 状态：{{ '运行中' if house.status == 'active' else '已停用' }} | 编号：{{ house.code or '未设置' }} | 用途：{{ house.purpose or '未设置' }}</p>

        <!-- 环境监控区域 -->
        <div class="card">
            <h3>实时环境监控</h3>
            <div class="env-grid">
                <div class="env-item">
                    <h4>温度</h4>
                    <p class="env-value">{{ latest_data.temperature if latest_data else '--' }} °C</p>
                </div>
                <div class="env-item">
                    <h4>湿度</h4>
                    <p class="env-value">{{ latest_data.humidity if latest_data else '--' }} %</p>
                </div>
                <div class="env-item">
                    <h4>光照</h4>
                    <p class="env-value">{{ latest_data.light_intensity if latest_data else '--' }} lux</p>
                </div>
                <div class="env-item">
                    <h4>CO2</h4>
                    <p class="env-value">{{ latest_data.co2_level if latest_data else '--' }} ppm</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="envChart"></canvas>
            </div>
        </div>

        <div class="grid-two" style="margin-top: 20px;">
            <div class="card">
                <h3>可种植作物设置</h3>
                <form id="allowedCropsForm">
                    <div class="crop-checkbox-group">
                        {% for crop in crop_library %}
                        <label class="crop-checkbox">
                            <input type="checkbox" name="crops" value="{{ crop.value }}" {% if crop.value in allowed_crop_values %}checked{% endif %} {% if role != 'admin' %}disabled{% endif %}>
                            <span>{{ crop.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    {% if role == 'admin' %}
                    <button class="btn btn-success" type="submit" style="margin-top:1rem;">保存允许作物</button>
                    {% endif %}
                </form>
            </div>

            <div class="card">
                <div class="card-header-flex">
                    <h3>作物管理控制</h3>
                    {% if role == 'admin' %}
                    <button class="btn btn-success btn-small" id="openPlantingModal">新增作物</button>
                    {% endif %}
                </div>
                <p>在这里快速执行浇水、施肥、温度调节或病害记录，方便跟踪养护历史。</p>
                <ul class="allowed-crop-list">
                    {% if allowed_crops %}
                        {% for crop in allowed_crops %}
                        <li>{{ crop.crop_name }}</li>
                        {% endfor %}
                    {% else %}
                        <li>尚未配置允许作物</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- 种植记录区域 -->
        <div class="card" style="margin-top: 20px;">
            <h3>当前种植作物</h3>
            <table style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th>作物类型</th>
                        <th>品种</th>
                        <th>种植日期</th>
                        <th>预计收获</th>
                        <th>状态</th>
                        <th>产量(kg)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for planting in plantings %}
                    <tr data-planting-id="{{ planting.id }}">
                        <td>{{ planting.crop_type }}</td>
                        <td>{{ planting.variety }}</td>
                        <td>{{ planting.plant_date }}</td>
                        <td>{{ planting.expected_harvest or '-' }}</td>
                        <td>
                            <span class="status-pill {{ 'status-on' if planting.status == 'growing' else 'status-off' }}">
                                {{ '生长中' if planting.status == 'growing' else
                                  '已收获' if planting.status == 'harvested' else '已失败' }}
                            </span>
                        </td>
                        <td>{{ planting.yield_kg or '-' }}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-small" onclick="recordCare({{ planting.id }}, 'watering')">浇水</button>
                                <button class="btn btn-small" onclick="recordCare({{ planting.id }}, 'fertilizing')">施肥</button>
                                <button class="btn btn-small" onclick="recordCare({{ planting.id }}, 'temperature')">温控</button>
                                <button class="btn btn-small" onclick="recordCare({{ planting.id }}, 'disease')">病害</button>
                                {% if role == 'admin' %}
                                <button class="btn btn-danger btn-small" onclick="deletePlanting({{ planting.id }})">删除</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="7" style="text-align: center;">暂无种植记录</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if plantings %}
        <div class="card" style="margin-top: 20px;">
            <h3>生长状态概览</h3>
            <div class="growth-cards">
                {% for planting in plantings %}
                <div class="growth-card">
                    <h4>{{ planting.crop_type }}</h4>
                    <p class="growth-stage">状态：{{ '生长中' if planting.status == 'growing' else '已收获' if planting.status == 'harvested' else '已失败' }}</p>
                    <p>品种：{{ planting.variety or '-' }}</p>
                    <p>种植天数：<span data-plant-date="{{ planting.plant_date }}">{{ planting.plant_date }}</span></p>
                    <p>备注：{{ planting.notes or '暂无备注' }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        </div>

        <!-- 生长阶段统计条形图 -->
        {% if plantings %}
        <div class="card" style="margin-top:20px;">
            <div class="card-header-flex">
                <h3>生长阶段统计</h3>
            </div>
            <div style="width:100%; max-width:800px; margin-top:10px;">
                <canvas id="growthStageChart"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="card" style="margin-top:20px;">
            <div class="card-header-flex">
                <h3>养护记录</h3>
                <button class="btn btn-secondary btn-small" onclick="refreshCareLogs()">刷新</button>
            </div>
            <ul class="care-log-list" id="careLogList">
                {% for log in care_logs %}
                <li>
                    <strong>{{ log.action_type }}</strong> - {{ log.crop_type or '未关联作物' }}
                    <span class="care-log-time">{{ log.created_at }}</span>
                    <p>{{ log.detail or '无备注' }}（记录人：{{ log.performed_by or '系统' }}）</p>
                </li>
                {% else %}
                <li>暂无记录</li>
                {% endfor %}
            </ul>
        </div>
    </main>

    {% if role == 'admin' %}
    <div class="modal" id="plantingModal">
        <div class="modal-content">
            <h3>新增作物</h3>
            <form id="plantingForm">
                <input type="hidden" name="greenhouse_id" value="{{ house.id }}">
                <div id="plantingError" class="form-error" style="display:none; margin-bottom:8px;"></div>
                <div class="form-group">
                    <label>作物类型</label>
                    <input type="text" name="crop_type" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>品种</label>
                    <input type="text" name="variety" class="form-control" required>
                </div>
                <div class="form-group dual">
                    <div>
                        <label>种植日期</label>
                        <input type="date" name="plant_date" class="form-control" required>
                    </div>
                    <div>
                        <label>预计收获</label>
                        <input type="date" name="expected_harvest" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea name="notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-success">保存</button>
                    <button type="button" class="btn btn-secondary" id="closePlantingModal">取消</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        const greenhouseId = {{ house.id }};

        // 绘制环境参数趋势图（近24小时）
        const ctx = document.getElementById('envChart').getContext('2d');
        fetch(`/api/sensor-data/${greenhouseId}?hours=24`)
            .then(res => res.json())
            .then(res => {
                if (res.status !== 'success') return;
                const data = res.data;
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(item => item.timestamp),
                        datasets: [
                            { label: '温度(°C)', data: data.map(item => item.temperature), borderColor: 'red' },
                            { label: '湿度(%)', data: data.map(item => item.humidity), borderColor: 'blue' }
                        ]
                    }
                });
            });

        // 生成生长阶段条形图（基于当前 plantings 数据）
        (function() {
            try {
                const plantingsData = {{ plantings|tojson }} || [];
                if (!plantingsData || plantingsData.length === 0) return;

                const counts = { growing: 0, harvested: 0, failed: 0 };
                plantingsData.forEach(p => {
                    const s = (p.status || '').toLowerCase();
                    if (s === 'growing') counts.growing += 1;
                    else if (s === 'harvested') counts.harvested += 1;
                    else counts.failed += 1;
                });

                const ctx2 = document.getElementById('growthStageChart');
                if (!ctx2) return;

                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['生长中', '已收获', '已失败'],
                        datasets: [{
                            label: '作物数量',
                            data: [counts.growing, counts.harvested, counts.failed],
                            backgroundColor: ['#4caf50', '#2196f3', '#f44336']
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, precision: 0 } }
                    }
                });
            } catch (e) {
                console.error('生长阶段图表初始化失败', e);
            }
        })();

        // 计算种植天数
        document.querySelectorAll('[data-plant-date]').forEach(el => {
            const date = new Date(el.dataset.plantDate);
            const diff = Math.floor((Date.now() - date.getTime()) / (1000 * 3600 * 24));
            el.textContent = `${diff} 天`;
        });

        const isAdmin = '{{ role }}' === 'admin';
        if (isAdmin) {
            const allowedForm = document.getElementById('allowedCropsForm');
            if (allowedForm) {
                allowedForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const selected = Array.from(this.querySelectorAll('input[name="crops"]:checked')).map(item => item.value);
                    fetch(`/api/greenhouse/${greenhouseId}/crops`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ crops: selected })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('作物配置已保存');
                            } else {
                                alert('保存失败');
                            }
                        });
                });
            }

            const modal = document.getElementById('plantingModal');
            const openBtn = document.getElementById('openPlantingModal');
            const closeBtn = document.getElementById('closePlantingModal');
            const plantingForm = document.getElementById('plantingForm');

            if (openBtn && modal) {
                openBtn.addEventListener('click', () => modal.classList.add('visible'));
            }
            if (closeBtn && modal) {
                closeBtn.addEventListener('click', () => modal.classList.remove('visible'));
            }

            if (plantingForm) {
                plantingForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const errorEl = document.getElementById('plantingError');
                    const formData = new FormData(this);
                    (async () => {
                        try {
                            const res = await fetch('/api/planting/add', { method: 'POST', body: formData });
                            let data = null;
                            try { data = await res.json(); } catch (e) { /* ignore */ }
                            if (res.ok && data && data.status === 'success') {
                                alert('已创建新的种植记录');
                                window.location.reload();
                            } else {
                                const msg = (data && data.message) ? data.message : (res.status === 400 ? '参数错误' : '创建失败');
                                if (errorEl) { errorEl.style.display = 'block'; errorEl.textContent = msg; }
                            }
                        } catch (err) {
                            if (errorEl) { errorEl.style.display = 'block'; errorEl.textContent = '网络或服务器错误'; }
                        }
                    })();
                });
            }
        }

        function recordCare(plantingId, actionType) {
            const detail = prompt('备注（可选）：') || '';
            fetch(`/api/planting/${plantingId}/care-log`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action_type: actionType, detail })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderCareLogs(data.logs);
                    } else {
                        alert('记录失败');
                    }
                });
        }

        function renderCareLogs(logs) {
            const list = document.getElementById('careLogList');
            if (!list) return;
            list.innerHTML = logs.map(log => `
                <li>
                    <strong>${log.action_type}</strong> - ${log.crop_type || '未关联作物'}
                    <span class="care-log-time">${log.created_at}</span>
                    <p>${log.detail || '无备注'}（记录人：${log.performed_by || '系统'}）</p>
                </li>
            `).join('');
        }

        function refreshCareLogs() {
            fetch(`/api/greenhouse/${greenhouseId}/care-logs`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderCareLogs(data.data);
                    }
                });
        }

        {% if role == 'admin' %}
        function deletePlanting(plantingId) {
            if (confirm('确定删除该种植记录吗？')) {
                fetch(`/api/planting/${plantingId}/delete`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();
                        } else {
                            alert('删除失败');
                        }
                    });
            }
        }
        {% endif %}
    </script>
</body>
</html>