<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大棚管理 - 温室控制系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>温室智能控制系统</h1>
        <div class="user-info">
            <span>当前用户: {{ username }} ({{ role }})</span>
            <a href="{{ url_for('logout') }}">退出登录</a>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="{{ url_for('index') }}">首页</a></li>
            <li><a href="{{ url_for('greenhouses') }}" class="active">大棚管理</a></li>
            <li><a href="{{ url_for('status') }}">系统状态</a></li>
            <!-- 其他导航项 -->
        </ul>
    </nav>

    <main>
        <h2>大棚列表</h2>
        <div id="houseMsg" class="form-error" style="display:none; margin-bottom:10px;"></div>

        {% if role == 'admin' %}
        <button id="addHouseBtn" class="btn btn-primary">新增大棚</button>
        {% endif %}

        <div class="card" style="margin-top: 20px;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>大棚名称</th>
                        <th>位置</th>
                        <th>面积(㎡)</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for house in houses %}
                    <tr>
                        <td>{{ house.id }}</td>
                        <td>{{ house.name }}</td>
                        <td>{{ house.location }}</td>
                        <td>{{ house.area }}</td>
                        <td>
                            <span class="status-{{ house.status }}">
                                {{ '运行中' if house.status == 'active' else '已停用' }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('greenhouse_detail', house_id=house.id) }}" class="btn btn-info">
                                查看详情
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" style="text-align: center;">暂无大棚数据</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // 新增大棚按钮事件（管理员），并在页面展示后端返回的错误信息
        function showHouseMessage(msg, isError=true) {
            const el = document.getElementById('houseMsg');
            if (!el) return;
            el.style.display = 'block';
            el.textContent = msg;
            el.style.color = isError ? '#b00020' : '#076';
        }

        document.getElementById('addHouseBtn')?.addEventListener('click', async function() {
            const name = prompt('请输入大棚名称：');
            const location = prompt('请输入位置：');
            const area = prompt('请输入面积（平方米）：');

            if (!(name && location && area)) return;

            try {
                const res = await fetch('/api/greenhouse/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `name=${encodeURIComponent(name)}&location=${encodeURIComponent(location)}&area=${encodeURIComponent(area)}`
                });
                let data = null;
                try { data = await res.json(); } catch(e) { /* ignore */ }

                if (res.ok && data && data.status === 'success') {
                    showHouseMessage('新增成功，正在刷新...', false);
                    setTimeout(() => location.reload(), 600);
                } else {
                    const msg = (data && data.message) ? data.message : (res.status === 409 ? '已存在相同名称或编码的大棚' : '新增失败，请重试');
                    showHouseMessage(msg, true);
                }
            } catch (err) {
                showHouseMessage('网络或服务器错误，请稍后再试');
            }
        });
    </script>
</body>
</html>