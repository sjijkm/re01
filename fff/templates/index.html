<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大棚智能控制系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .content-section {
            display: none;
            margin-top: 20px;
        }
        .content-section.active {
            display: block;
        }
        .data-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .data-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .data-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .device-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .task-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: white;
        }
        .reminder-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .reminder-item.untriggered {
            background-color: #fff8e1;
        }
        .reminder-item.triggered {
            background-color: #e8f5e9;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">大棚智能控制系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-target="monitoring">数据监控</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="devices">设备控制</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="tasks">农活记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="reminders">提醒设置</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="settings">系统设置</a>
                    </li>
                </ul>
            </div>
            <div class="text-white" id="system-status">系统运行中</div>
        </div>
    </nav>

    <div class="container">
        <!-- 数据监控页面 -->
        <div id="monitoring" class="content-section active">
            <h2>大棚环境数据监控</h2>
            <div class="row">
                <div class="col-md-3">
                    <div class="data-card">
                        <h3 style="background-color: #dc3545;">温度</h3>
                        <div class="data-value" id="temp-value">--</div>
                        <div>℃</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="data-card">
                        <h3 style="background-color: #0d6efd;">湿度</h3>
                        <div class="data-value" id="humidity-value">--</div>
                        <div>%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="data-card">
                        <h3 style="background-color: #ffc107;">光照</h3>
                        <div class="data-value" id="light-value">--</div>
                        <div>klux</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="data-card">
                        <h3 style="background-color: #6610f2;">CO2浓度</h3>
                        <div class="data-value" id="co2-value">--</div>
                        <div>ppm</div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <canvas id="sensor-chart" height="300"></canvas>
            </div>
        </div>

        <!-- 设备控制页面 -->
        <div id="devices" class="content-section">
            <h2>设备控制</h2>
            <div class="form-check form-switch mb-4">
                <input class="form-check-input" type="checkbox" id="auto-control" checked>
                <label class="form-check-label" for="auto-control">开启自动控制模式</label>
            </div>
            <div class="row" id="devices-container">
                <!-- 设备卡片将通过JS动态生成 -->
            </div>
        </div>

        <!-- 农活记录页面 -->
        <div id="tasks" class="content-section">
            <h2>农活记录</h2>
            <div class="input-group mb-4">
                <input type="text" id="task-input" class="form-control" placeholder="输入农活内容...">
                <button class="btn btn-success" id="add-task">添加农活</button>
            </div>

            <h3>待完成农活</h3>
            <div id="pending-tasks">
                <!-- 待完成任务将通过JS动态生成 -->
            </div>

            <h3 class="mt-4">已完成农活</h3>
            <div id="completed-tasks">
                <!-- 已完成任务将通过JS动态生成 -->
            </div>
        </div>

        <!-- 提醒设置页面 -->
        <div id="reminders" class="content-section">
            <h2>提醒设置</h2>
            <button class="btn btn-success mb-4" id="add-reminder-btn">添加新提醒</button>

            <div id="reminders-container">
                <!-- 提醒将通过JS动态生成 -->
            </div>
        </div>

        <!-- 系统设置页面 -->
        <div id="settings" class="content-section">
            <h2>系统设置</h2>
            <div class="card p-4">
                <form id="settings-form">
                    <div class="mb-3">
                        <label class="form-label">温度阈值 (℃)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" step="0.1" class="form-control" name="temperature_min" placeholder="最小值">
                            </div>
                            <div class="col-md-6">
                                <input type="number" step="0.1" class="form-control" name="temperature_max" placeholder="最大值">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">湿度阈值 (%)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" step="0.1" class="form-control" name="humidity_min" placeholder="最小值">
                            </div>
                            <div class="col-md-6">
                                <input type="number" step="0.1" class="form-control" name="humidity_max" placeholder="最大值">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">光照阈值 (klux)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" step="0.1" class="form-control" name="light_min" placeholder="最小值">
                            </div>
                            <div class="col-md-6">
                                <input type="number" step="0.1" class="form-control" name="light_max" placeholder="最大值">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">CO2浓度阈值 (ppm)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="number" class="form-control" name="co2_min" placeholder="最小值">
                            </div>
                            <div class="col-md-6">
                                <input type="number" class="form-control" name="co2_max" placeholder="最大值">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">保存设置</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 提醒添加模态框 -->
    <div class="modal fade" id="reminder-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新提醒</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reminder-form">
                        <div class="mb-3">
                            <label class="form-label">提醒标题</label>
                            <input type="text" class="form-control" id="reminder-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">提醒内容</label>
                            <textarea class="form-control" id="reminder-content" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">提醒时间</label>
                            <input type="datetime-local" class="form-control" id="reminder-time" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="save-reminder">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 导航切换
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // 更新导航激活状态
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                // 显示对应内容区域
                const target = this.getAttribute('data-target');
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(target).classList.add('active');

                // 加载对应数据
                if (target === 'monitoring') loadSensorData();
                if (target === 'devices') loadDevices();
                if (target === 'tasks') loadTasks();
                if (target === 'reminders') loadReminders();
                if (target === 'settings') loadSettings();
            });
        });

        // 系统状态更新
        function updateSystemStatus() {
            const now = new Date();
            document.getElementById('system-status').textContent =
                `系统运行中 - ${now.toLocaleString()}`;
        }
        setInterval(updateSystemStatus, 1000);
        updateSystemStatus();

        // 传感器数据图表
        let sensorChart;
        function initSensorChart() {
            const ctx = document.getElementById('sensor-chart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: '温度 (℃)', data: [], borderColor: '#dc3545', tension: 0.1 },
                        { label: '湿度 (%)', data: [], borderColor: '#0d6efd', tension: 0.1 },
                        { label: '光照 (klux)', data: [], borderColor: '#ffc107', tension: 0.1 },
                        { label: 'CO2 (ppm)', data: [], borderColor: '#6610f2', tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '时间' } },
                        y: { title: { display: true, text: '数值' } }
                    }
                }
            });
        }

        // 加载传感器数据
        function loadSensorData() {
            fetch('/api/sensor-data?count=30')
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);

                    if (data.length === 0) return;

                    // 更新最新数据卡片
                    const latest = data[data.length - 1];
                    document.getElementById('temp-value').textContent = latest.temperature;
                    document.getElementById('humidity-value').textContent = latest.humidity;
                    document.getElementById('light-value').textContent = latest.light;
                    document.getElementById('co2-value').textContent = latest.co2;

                    // 更新图表
                    if (!sensorChart) initSensorChart();

                    sensorChart.data.labels = data.map(item => {
                        const d = new Date(item.timestamp);
                        return `${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
                    });

                    sensorChart.data.datasets[0].data = data.map(item => item.temperature);
                    sensorChart.data.datasets[1].data = data.map(item => item.humidity);
                    sensorChart.data.datasets[2].data = data.map(item => item.light);
                    sensorChart.data.datasets[3].data = data.map(item => item.co2);

                    sensorChart.update();
                })
                .catch(error => console.error('加载传感器数据失败:', error));
        }

        // 定时更新传感器数据
        setInterval(() => {
            if (document.getElementById('monitoring').classList.contains('active')) {
                loadSensorData();
            }
        }, 10000);

        // 加载设备列表
        function loadDevices() {
            fetch('/api/devices')
                .then(response => response.json())
                .then(devices => {
                    if (devices.error) throw new Error(devices.error);

                    const container = document.getElementById('devices-container');
                    container.innerHTML = '';

                    devices.forEach(device => {
                        const card = document.createElement('div');
                        card.className = 'col-md-6 device-card';
                        card.innerHTML = `
                            <h3>${device.name}</h3>
                            <p>${device.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="status badge ${device.status ? 'bg-success' : 'bg-danger'}">
                                    ${device.status ? '已开启' : '已关闭'}
                                </span>
                                <button class="toggle-device btn ${device.status ? 'btn-danger' : 'btn-success'}"
                                        data-id="${device.id}">
                                    ${device.status ? '关闭' : '开启'}
                                </button>
                            </div>
                        `;
                        container.appendChild(card);
                    });

                    // 添加设备切换事件
                    document.querySelectorAll('.toggle-device').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const deviceId = this.getAttribute('data-id');
                            toggleDevice(deviceId, this);
                        });
                    });
                })
                .catch(error => console.error('加载设备失败:', error));
        }

        // 切换设备状态
        function toggleDevice(deviceId, btnElement) {
            fetch(`/api/devices/${deviceId}`, { method: 'PUT' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);

                    // 更新按钮状态
                    const newStatus = data.status;
                    btnElement.className = `toggle-device btn ${newStatus ? 'btn-danger' : 'btn-success'}`;
                    btnElement.textContent = newStatus ? '关闭' : '开启';

                    // 更新状态标签
                    const statusBadge = btnElement.parentElement.querySelector('.status');
                    statusBadge.className = `status badge ${newStatus ? 'bg-success' : 'bg-danger'}`;
                    statusBadge.textContent = newStatus ? '已开启' : '已关闭';
                })
                .catch(error => console.error('切换设备状态失败:', error));
        }

        // 加载任务列表
        function loadTasks() {
            fetch('/api/tasks')
                .then(response => response.json())
                .then(tasks => {
                    if (tasks.error) throw new Error(tasks.error);

                    const pendingContainer = document.getElementById('pending-tasks');
                    const completedContainer = document.getElementById('completed-tasks');
                    pendingContainer.innerHTML = '';
                    completedContainer.innerHTML = '';

                    let pendingCount = 0;
                    let completedCount = 0;

                    tasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = 'task-item';
                        taskElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p>${task.content}</p>
                                    <small class="text-muted">创建于: ${new Date(task.create_time).toLocaleString()}</small>
                                    ${task.completed ? `<br><small class="text-muted">完成于: ${new Date(task.complete_time).toLocaleString()}</small>` : ''}
                                </div>
                                ${!task.completed ? `<button class="complete-task btn btn-success" data-id="${task.id}">完成</button>` : ''}
                            </div>
                        `;

                        if (task.completed) {
                            completedContainer.appendChild(taskElement);
                            completedCount++;
                        } else {
                            pendingContainer.appendChild(taskElement);
                            pendingCount++;
                        }
                    });

                    // 空状态提示
                    if (pendingCount === 0) {
                        pendingContainer.innerHTML = '<p class="text-muted">暂无待完成的农活</p>';
                    }
                    if (completedCount === 0) {
                        completedContainer.innerHTML = '<p class="text-muted">暂无已完成的农活</p>';
                    }

                    // 添加完成任务事件
                    document.querySelectorAll('.complete-task').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-id');
                            completeTask(taskId);
                        });
                    });
                })
                .catch(error => console.error('加载任务失败:', error));
        }

        // 添加新任务
        document.getElementById('add-task').addEventListener('click', function() {
            const content = document.getElementById('task-input').value.trim();
            if (!content) return;

            fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);

                document.getElementById('task-input').value = '';
                loadTasks();
            })
            .catch(error => console.error('添加任务失败:', error));
        });

        // 标记任务为完成
        function completeTask(taskId) {
            fetch(`/api/tasks/${taskId}/complete`, { method: 'PUT' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    loadTasks();
                })
                .catch(error => console.error('完成任务失败:', error));
        }

        // 加载提醒列表
        function loadReminders() {
            fetch('/api/reminders')
                .then(response => response.json())
                .then(reminders => {
                    if (reminders.error) throw new Error(reminders.error);

                    const container = document.getElementById('reminders-container');
                    container.innerHTML = '';

                    if (reminders.length === 0) {
                        container.innerHTML = '<p class="text-muted">暂无提醒设置</p>';
                        return;
                    }

                    reminders.forEach(reminder => {
                        const reminderElement = document.createElement('div');
                        reminderElement.className = `reminder-item ${reminder.triggered ? 'triggered' : 'untriggered'}`;
                        reminderElement.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <h4>${reminder.title}</h4>
                                <button class="delete-reminder btn btn-danger" data-id="${reminder.id}">删除</button>
                            </div>
                            <p>${reminder.content}</p>
                            <small class="text-muted">
                                提醒时间: ${new Date(reminder.reminder_time).toLocaleString()}
                                ${reminder.triggered ? ' (已触发)' : ''}
                            </small>
                        `;
                        container.appendChild(reminderElement);
                    });

                    // 添加删除提醒事件
                    document.querySelectorAll('.delete-reminder').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const reminderId = this.getAttribute('data-id');
                            deleteReminder(reminderId);
                        });
                    });
                })
                .catch(error => console.error('加载提醒失败:', error));
        }

        // 添加提醒模态框
        const reminderModal = new bootstrap.Modal(document.getElementById('reminder-modal'));
        document.getElementById('add-reminder-btn').addEventListener('click', function() {
            // 设置默认时间为当前时间加1小时
            const defaultTime = new Date();
            defaultTime.setHours(defaultTime.getHours() + 1);
            const isoTime = defaultTime.toISOString().slice(0, 16); // 格式化为YYYY-MM-DDTHH:MM

            document.getElementById('reminder-title').value = '';
            document.getElementById('reminder-content').value = '';
            document.getElementById('reminder-time').value = isoTime;

            reminderModal.show();
        });

        // 保存提醒
        document.getElementById('save-reminder').addEventListener('click', function() {
            const title = document.getElementById('reminder-title').value.trim();
            const content = document.getElementById('reminder-content').value.trim();
            const time = document.getElementById('reminder-time').value;

            if (!title || !time) return;

            // 转换为MySQL datetime格式 (YYYY-MM-DD HH:MM:SS)
            const formattedTime = time.replace('T', ' ') + ':00';

            fetch('/api/reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    reminder_time: formattedTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);

                reminderModal.hide();
                loadReminders();
            })
            .catch(error => console.error('添加提醒失败:', error));
        });

        // 删除提醒
        function deleteReminder(reminderId) {
            if (!confirm('确定要删除这个提醒吗？')) return;

            fetch(`/api/reminders/${reminderId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    loadReminders();
                })
                .catch(error => console.error('删除提醒失败:', error));
        }

        // 加载系统设置
        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(settings => {
                    if (settings.error) throw new Error(settings.error);

                    document.querySelector('input[name="temperature_min"]').value = settings.temperature.min;
                    document.querySelector('input[name="temperature_max"]').value = settings.temperature.max;
                    document.querySelector('input[name="humidity_min"]').value = settings.humidity.min;
                    document.querySelector('input[name="humidity_max"]').value = settings.humidity.max;
                    document.querySelector('input[name="light_min"]').value = settings.light.min;
                    document.querySelector('input[name="light_max"]').value = settings.light.max;
                    document.querySelector('input[name="co2_min"]').value = settings.co2.min;
                    document.querySelector('input[name="co2_max"]').value = settings.co2.max;
                })
                .catch(error => console.error('加载设置失败:', error));
        }

        // 保存系统设置
        document.getElementById('settings-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const settings = {
                temperature: {
                    min: parseFloat(this.temperature_min.value),
                    max: parseFloat(this.temperature_max.value)
                },
                humidity: {
                    min: parseFloat(this.humidity_min.value),
                    max: parseFloat(this.humidity_max.value)
                },
                light: {
                    min: parseFloat(this.light_min.value),
                    max: parseFloat(this.light_max.value)
                },
                co2: {
                    min: parseFloat(this.co2_min.value),
                    max: parseFloat(this.co2_max.value)
                }
            };

            fetch('/api/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert('设置保存成功');
            })
            .catch(error => console.error('保存设置失败:', error));
        });

        // 页面加载时初始化
        window.addEventListener('load', function() {
            loadSensorData();
            initSensorChart();
        });
    </script>
</body>
</html>