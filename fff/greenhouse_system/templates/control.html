<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备控制 - 温室智能控制系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>温室智能控制系统</h1>
        <div class="user-info">
            <span>当前用户: {{ username }} ({{ role }})</span>
            <a href="{{ url_for('logout') }}">退出登录</a>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="{{ url_for('index') }}">首页</a></li>
            <li><a href="{{ url_for('status') }}">系统状态</a></li>
            <li><a href="{{ url_for('device_control') }}" class="active">设备控制</a></li>
            <li><a href="{{ url_for('greenhouses') }}">大棚管理</a></li>
            <li><a href="{{ url_for('history') }}">历史数据</a></li>
            <li><a href="{{ url_for('alerts') }}">报警信息</a></li>
            <li><a href="{{ url_for('schedule') }}">定时任务</a></li>
            <li><a href="{{ url_for('calibration') }}">传感器校准</a></li>
        </ul>
    </nav>

    <main>
        <h2>设备控制中心</h2>

        <!-- 控制模式切换卡片 -->
        <div class="card">
            <h3>控制模式设置</h3>
            <div class="mode-control">
                <p>当前模式：<span id="currentMode" class="mode-badge">{{ '自动' if auto_mode else '手动' }}</span></p>

                {% if role == 'admin' %}
                <button id="toggleModeBtn" class="btn {{ 'btn-warning' if auto_mode else 'btn-success' }}">
                    {{ '切换到手动模式' if auto_mode else '切换到自动模式' }}
                </button>
                <p class="mode-hint">
                    自动模式：系统根据传感器数据自动调节设备<br>
                    手动模式：仅通过下方按钮手动控制设备
                </p>
                {% else %}
                <p class="mode-hint">仅管理员可切换控制模式</p>
                {% endif %}
            </div>
        </div>

        <!-- 设备控制列表 -->
        <div class="card" style="margin-top: 20px;">
            <h3>设备状态与控制</h3>
            <table>
                <thead>
                    <tr>
                        <th>设备名称</th>
                        <th>当前状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.device_name.replace('_', ' ') }}</td>
                        <td>
                            <span class="status-{{ device.status|lower }}">
                                {{ device.status }}
                            </span>
                        </td>
                        <td>
                            <button
                                onclick="setDeviceStatus('{{ device.device_name }}', 'ON')"
                                class="btn btn-success"
                                {% if auto_mode and role != 'admin' %}disabled title="自动模式下仅管理员可操作"{% endif %}
                            >
                                开启
                            </button>
                            <button
                                onclick="setDeviceStatus('{{ device.device_name }}', 'OFF')"
                                class="btn btn-danger"
                                {% if auto_mode and role != 'admin' %}disabled title="自动模式下仅管理员可操作"{% endif %}
                            >
                                关闭
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <p>&copy; 2023 温室智能控制系统</p>
    </footer>

    <script>
        // 模式切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleModeBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    fetch('/api/toggle-mode', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 更新模式显示
                                const isAuto = data.auto_mode;
                                document.getElementById('currentMode').textContent = isAuto ? '自动' : '手动';
                                toggleBtn.textContent = isAuto ? '切换到手动模式' : '切换到自动模式';
                                toggleBtn.className = isAuto ? 'btn btn-warning' : 'btn btn-success';

                                // 更新设备按钮状态（自动模式下非管理员禁用按钮）
                                const buttons = document.querySelectorAll('button[onclick^="setDeviceStatus"]');
                                buttons.forEach(btn => {
                                    if ('{{ role }}' !== 'admin') {
                                        btn.disabled = isAuto;
                                        btn.title = isAuto ? '自动模式下仅管理员可操作' : '';
                                    }
                                });

                                alert(`已切换到${isAuto ? '自动' : '手动'}模式`);
                            } else {
                                alert('模式切换失败，请重试');
                            }
                        });
                });
            }
        });

        // 设备控制功能
        function setDeviceStatus(deviceName, status) {
            fetch(`/api/device/${deviceName}/${status}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 刷新页面更新状态（简单方式，也可局部更新）
                        location.reload();
                    } else {
                        alert('操作失败：' + (data.message || '未知错误'));
                    }
                });
        }
    </script>
</body>
</html>